<head>
  <script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.0.0/dygraph.min.js"></script>
  <link rel="stylesheet" src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.0.0/dygraph.min.css" />
</head>
<body>
<div style="height:20px;"></div>
<div style="width:60%;margin:auto;">
<h1> RNN-stocks-prediction <span>[this is the doc for <a href="https://github.com/SolbiatiAlessandro/RNN-stocks-prediction">RNN-stocks-prediction</a>]</span></h1>
<h3> Another attempt to use Deep-Learning in financial markets*</h3>
<p><b>project mission</b>: implement some AI systems described in research papers in a full-stack application deployed to the market.</p>
  
<p style="font-size:9px">* this web page is left without proper formatting on purpose </p>
<div>

<div style="height:20px;"></div>

<div style="width:60%;margin:auto;">
<p>Recently I have been playing around with AI and Deep-Learning and I came out with this idea about DL applied to financial markets. Turns out that there are PLENTY of people already doing that out-there, here is a non-comprehensive list:</p>
<ul>
  <li><a href="https://medium.com/@TalPerry/deep-learning-the-stock-market-df853d139e02">'deep-learning-the-stock-market', Tal Perry</a></li>
  <li><a href="http://www.jakob-aungiers.com/articles/a/LSTM-Neural-Network-for-Time-Series-Prediction">'LSTM-Neural-Network-for-Time-Series-Prediction', Aungiers</a></li>
  <li>'Recurrent neural networks approach to the financial forecast of Google assets', Di Persio, Honchar, 2017</li>
  <li>'Artificial neural networks apporach to the forecast of stock market price movements', Di Persio, Honchar, 2016</li>
</ul>
<p> After an intensive summer-school about DL and intensive reading of papers about the topic I decided to start my own project: here we are.</p>
</div>

<div style="height:20px;"></div>
<div style="width:60%;margin:auto;">
  <h2>Day 1 - kickstarting with regression</h2>
  <img src="https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/img/day1.jpg" width="500px" />
  <p>This is my work-desk on Day1. So after extensive reading of already existing implementation on the web about RNN to fin markets I am bit disappointed. Most of the time people have no idea what they are speaking about either because they don't know anything about finance or because they don't know anything about the foundation of Deep Learning (or both). On the other hand, what excites me most is that there are plenty of papers about people claiming to predict stock prices with accuracy from 65% to 80%, that is impressive. So my guideline is to try to implement those RNN models in my application, and apply the prediction to some financial instruments. Currently I would go for binary options, it seems fitting pretty well with the RNN prediction capabilities. There are two main types of approach to the problem:<p>
  <ul>
    <li><b>(A) Regression problem</b>: the most straightforward, given the last Ndays predict tomorrow closing price.</li>
    <li><b>(B) Classification problem</b>: given the last Ndays, will the price tomorrow goes up or down? (binary classification).</li>
  </ul>
  <p>Full of example of (A) on the internet, and the truth it that they don't work so well. Anyway since they are relatively easy to impelement I gave it a try and here is the outcome.</p>
  <div id="graphdiv3" style="width:500px; height:300px;"></div>
  <p style="font-size:12px">This is graph is the normalized closing price of GOOGL(on a 30periods window), with actual and predicted. I trained the NN with 4 years of prices and 10 epochs.</h8>
  <p>So the graph is showing 'acutal' as the target price and 'predicted' as the price that the NN predicts. How does it work? Is really simple.</p>
  <ul>
    <li>use Pandas to download and create a DataFrame with OHLCV data</li>
    <li>create the tensor of dimensions (Batch_Size, 30, 5), so 30 time steps and 5 features</li>
    <li>split train and test data</li>
    <li>build the RNN model with Keras: I used LSTM + Dropout, a really simple implementation</li>
    <li>train the model,used 100 batch_size and 10 epochs</li>
    <li>predict the outcome from X_Test and compare the prediction with actual values</li>
  <p>The full code of this implementation is in the repo <a href="https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/regression.py">regression.py</a></p>
  <p>So the predictions are really bad, why is that? Of course the NN had not enough training data and the model is quite too simple: the papers suggest to implement at least two stacked LSTM layers with dropout and everything. Regarding the data (now the NN is trained only on GOOGL prices from 2012 to 2016) I should give the NN at least 20/30years of stock prices to acquire some consistency in the predictions. Anyway, this first example was interesting as shows that the NN is actually working an able to detect the trend in stock prices, even if not ready to do any useful prediction right now.</p>
  <div id="graphdiv4" style="width:500px; height:300px;"></div>
  <p style="font-size:12px">Same as above but this time the NN is trained with 16 years of stock prices, what is happening here is that the NN just take yesterday price and change a bit the value with no big difference. Thisresult is actually really bad from a prediction point of view, but is often misjudged as 'excellent' by people using Keras for the first time thinking that the NN is predicting the future: well, is not. Is just copying yesterday price.</h8>
  <p> The problem with regression is that the NN is not actually learning any pattern in the market, is just saying 'tomorrow price is the same as yesterday'. I found literally dozens of online courses and similar where they don't really understand what's going on and think that the NN is actually predicting with 100% accuracy the price of tomorrow, last graph below for regression problem, I trained the NN with 20years of data using a more complex model but the outcome doesn't change.</p>
  <div id="graphdiv5"style="width:500px; height:300px;"></div> 
  <p><b>Regression or Classification?</b> I would stop here improving the regression model (A) and spend my energy for the classification model (B). Why is that? In my opinion regression model is not the answer, as the OHLCV data are not enough for this kind of prediction. If we really want to predict the stock price consistently we need some sentiment analysis and other interesting things in our model, furthermore there is the accuracy question: if I am predicting the price I need a really high accuracy to implement it in a trading system or something. On the otherside, the classification problem woulde be extremely useful even if solved with a 60-70% accuracy. Why is that? I am thinking about some trading strategy with binary options. For now suffice it to say that if I am really able to solve the classification problem with something like 68% accuracy I am done: binary options have a break even of 53% and implementing an algo trading on that shouldn't be so difficult. Let's see what's next</p> 
</div>
<div style="height:20px;"></div>
<div style="width:60%;margin:auto;">
  <h2>Day 2 - classification time</h2>
  <img src="https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/img/day2.jpg" width="500px" />
  <p>BIGNEWS: I managed to speak with a PhD in DeepLearning from Tsinghua-Uni and we will have lunch sat, hope he will gives me great insight on what I am doing right/wrong.</p>
  <p>As I said, today I will focus on classification problem. So how does it work? This is my view up to now.</p>
  <ul>
    <li> INPUT - 30-days window <b>normalized log-returns</b>: a log return is defined with a function like this 'ret = lambda x,y: log(y/x)', and the returns must be normalized with a funct like this 'zscore = lambda x:(x -x.mean())/x.std()'. Easy stuff. The not-so-easy stuff here is whether to consider all the returns on OHLCV <b>(option I2)</b> or only the returns on Close prices <b>(option I1)</b>. I will consider and try both options: I2 means considering much more info (5 features in the NN) about the financial asset that could not be so relevant, instead I1 is about just using closing prices (1 feature implementation) that should be more straightforward <i>for humans</i>. I will try both options and see how the NN react. This time we will have an accuracy value to tell us some detailed info about the performance of our dear NN.</li>
    <li> OUTPUT - <b>label</b> for tomorrow behaviour of (closing)price: also here we have a couple of choice to make, the first choice <b>(option O1)</b> is about a binary classification in the label, i.e. a binary vector [1,0] or [0,1] to show if the price goes up or down. The second choice <b>(option O2)</b> is implementing a multi-class classification, that could be understood as a "discrete mapping" from the continuous log return interval [-INF; +INF] to a discrete interval {-5, -4, .. , 4, 5}. As before, O2 is more difficult to implement and carry out more information, I will have a try with both and see the different outcomes.</li>
  </ul>
  <p>After a few hours of testing and reading some papers about this topic I figured out that really good accuracy is obtained with the tuple I2-O1, that is multivariate input of all the OLHCV data and as output a binary classification [1,0] or [0,1] (not multi-class) of the predicted behaviour of the price. I will go for that one, as my next framework implementation.</p>
  <p><b>- ATTENTION: IMMINENT BREAKTHROUGH -</b></p>
  <p>So I wrote the Neural Network with I2-O1 configuration and the results were suprisingly good, on the training data of GOOGL stock price from 2000-2016 the NN got a <u>prediction accuracy of 63%</u>. What does it mean? That if you gave the last 30 days OHLCV prices from Yahoo Finance to the Neural Network it will be predict the price of tomorrow with an accuracy of 63% (right 63 times on 100). This is a great news since it mean that the NN is actually working and acquiring some prediction capabilities. Still, the validation accuracy is between 52-54%, so there is a large room for improvement. Here is the training accuracy and validation accuracy for the model.</p>
  <div id="graphdiv6"style="width:500px; height:300px;"></div> 
  <p>Right now I am pretty positive, since the project is becoming meaningful. I am actually creating something that is able to predict prices consistently and <b>improves</b> during the training. This concept of 'training' the Neural Network really excites me, I mean seeing actually the NN getting better and better at predicting stock prices during the training. To highlight this concept I show you here the 'loss function', that is the difference between the predicted and actual value. As you see, during the training the loss is decreasing more and more (wow!).</p>
  <div id="graphdiv7"style="width:500px; height:300px;"></div> 
</div>
<div style="height:20px;"></div>
  
<script type="text/javascript">
  g3 = new Dygraph(
    document.getElementById("graphdiv3"),
    "https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/csv/regressionA.csv",
    {
      rollPeriod: 1,
      showRoller: true,
      ylabel: 'stock price (normalized)',
      xlabel: 'time (days)'
    }
  );
  g4 = new Dygraph(
    document.getElementById("graphdiv4"),
    "https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/csv/regressionB.csv",
    {
      dateWindow: [80,120],
      rollPeriod: 1,
      showRoller: true,
      ylabel: 'stock price (normalized)',
      xlabel: 'time (days)'
    }
  );
    g5 = new Dygraph(
    document.getElementById("graphdiv5"),
    "https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/csv/regressionC.csv",
    {
      dateWindow: [80,120],
      rollPeriod: 1,
      showRoller: true,
      ylabel: 'stock price (normalized)',
      xlabel: 'time (days)'
    }
  );
   g6 = new Dygraph(
    document.getElementById("graphdiv6"),
    "https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/csv/classification_acc.csv",
    {
      rollPeriod: 1,
      showRoller: true,
      ylabel: 'accuracy (%)',
      xlabel: 'training time (epochs)'
    }
  );
   g7 = new Dygraph(
    document.getElementById("graphdiv7"),
    "https://raw.githubusercontent.com/SolbiatiAlessandro/RNN-stocks-prediction/master/docs/csv/classification_loss.csv",
    {
      rollPeriod: 1,
      showRoller: true,
      ylabel: 'loss (%)',
      xlabel: 'training time (epochs)'
    }
  );
  
</script>
</body>

